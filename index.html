<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Growing Flow</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b0f14; color:#e7eef7; }
    .wrap { max-width: 1150px; margin: 0 auto; padding: 22px; }
    .card { background:#111826; border:1px solid #1f2a3a; border-radius: 16px; padding: 16px; }
    h1 { margin: 0 0 8px; font-size: 22px; }
    .sub { opacity:.85; margin: 0 0 16px; line-height:1.4; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    label { display:block; font-size: 12px; opacity:.9; margin-bottom:6px; }
    input, button {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid #263246;
      background:#0d1420;
      color:#e7eef7;
      outline: none;
    }
    input:focus { border-color:#3b82f6; }
    .btn { cursor:pointer; background:#1b2a44; border-color:#2b3b55; font-weight:700; }
    .btn:hover { background:#223657; }
    .muted { opacity:.8; font-size: 12px; line-height: 1.45; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .row input[type="checkbox"] { width:auto; }
    .summary { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 12px; }
    .kpi { background:#0d1420; border:1px solid #263246; border-radius: 14px; padding: 12px; }
    .kpi .t { font-size: 12px; opacity:.8; margin-bottom:6px; }
    .kpi .v { font-size: 18px; font-weight: 800; }
    .kpi .s { font-size: 12px; opacity:.8; margin-top:6px; }
    .tabs { display:flex; gap:8px; margin-top: 14px; flex-wrap: wrap; }
    .tab { width:auto; padding: 8px 10px; border-radius: 999px; border:1px solid #263246; background:#0d1420; cursor:pointer; font-weight:700; font-size: 12px; }
    .tab.active { border-color:#3b82f6; }
    table { width:100%; border-collapse: collapse; overflow:hidden; }
    thead th {
      text-align:left; font-size: 12px; opacity:.85;
      padding: 10px; background:#0d1420; border-bottom:1px solid #263246;
      position: sticky; top: 0;
    }
    tbody td { padding: 10px; border-bottom:1px solid #1f2a3a; font-size: 13px; }
    tbody tr:hover { background:#0f1726; }
    .mono { font-variant-numeric: tabular-nums; }
    .sectionTitle { margin: 10px 0 6px; font-size: 13px; opacity: .9; font-weight: 800; }
    .box { background:#0d1420; border:1px solid #263246; border-radius: 14px; padding: 12px; }
    @media (max-width: 900px){
      .grid, .grid3, .summary { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Growing Flow</h1>
      <p class="sub">
        Правила: Day 1 = 0.3% на суму потоку. Далі +0.01% за кожен paid day.
        Неділя: 0 reward і ставка не росте. Винагорода накопичується окремо (копілка), депозит не реінвестується.
        Вивід rewards: копілка стає 0 і прогрес ставки скидається, наступний paid day починає з 0.3%.
      </p>

      <div class="grid3">
        <div>
          <label>Сума депозиту (USDT)</label>
          <input id="amount" type="number" min="0" step="0.01" value="1000" />
        </div>

        <div>
          <label>Дата депозиту</label>
          <input id="depositDate" type="date" />
        </div>

        <div>
          <label>Валюта відображення</label>
          <input id="currency" type="text" value="USDT" />
        </div>
      </div>

      <div class="box" style="margin-top:12px;">
        <div class="sectionTitle">ECR підтяжка (auto)</div>

        <div class="grid3">
          <div>
            <label>Курс ECR (₮ за 1 ECR)</label>
            <input id="ecrRate" type="number" step="0.01" value="816.80" />
          </div>

          <div>
            <label>Мультиплікатор потоку</label>
            <input id="boostPct" type="text" readonly value="100%" />
          </div>

          <div>
            <label>Потік відкриється на</label>
            <input id="boostedAmount" type="text" readonly value="0" />
          </div>
        </div>

        <div class="grid3" style="margin-top:10px;">
          <div>
            <label>Додатково треба (₮)</label>
            <input id="extraFiat" type="text" readonly value="0" />
          </div>

          <div>
            <label>Потрібно ECR</label>
            <input id="ecrNeeded" type="text" readonly value="0" />
          </div>

          <div>
            <label>Пояснення</label>
            <input id="ecrNote" type="text" readonly value="ECR = extra₮ / rate" />
          </div>
        </div>

        <div class="muted" style="margin-top:10px;">
          Таблиця: 100=130%, 500=140%, 1000=150%, 2500=160%, 5000=180%, 10000=200%, 25000=210%, 50000=230%, 100000=250%, 250000=260%, 500000=270%, 1000000=280%
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="grid">
        <div class="box">
          <div class="sectionTitle">Налаштування ставки</div>
          <div class="grid">
            <div>
              <label>Стартова ставка Day 1 (%)</label>
              <input id="startRate" type="number" step="0.01" value="0.30" />
            </div>
            <div>
              <label>Крок росту ставки (+% за paid day)</label>
              <input id="rateStep" type="number" step="0.01" value="0.01" />
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <input id="startNextDay" type="checkbox" checked />
            <label for="startNextDay" style="margin:0">Починати нарахування з наступного дня після депозиту</label>
          </div>

          <div class="muted" style="margin-top:10px;">
            Неділя завжди пропуск: 0 reward і не додається +0.01% до ставки.
          </div>
        </div>

        <div class="box">
          <div class="sectionTitle">Вивід rewards (скидання прогресу)</div>
          <div class="muted">
            Додай дати, коли ти виводиш rewards. У ці дні: копілка (wallet) обнуляється, reward = 0, прогрес ставки скидається.
          </div>

          <div style="height:10px"></div>

          <label>Дати виводу (через кому) у форматі YYYY-MM-DD</label>
          <input id="withdrawDates" type="text" placeholder="Напр: 2026-01-25, 2026-02-10" value="" />
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="grid">
        <button class="btn" id="calcBtn">Розрахувати</button>
        <button class="btn" id="exportBtn">Export CSV</button>
      </div>

      <div class="summary" id="kpiWrap" style="display:none;">
        <div class="kpi">
          <div class="t">Депозит</div>
          <div class="v mono" id="kpiStart">0</div>
          <div class="s mono" id="kpiRows"></div>
        </div>
        <div class="kpi">
          <div class="t">Підсумок</div>
          <div class="v mono" id="kpiEnd">0</div>
          <div class="s mono" id="kpiGain">0</div>
        </div>
        <div class="kpi">
          <div class="t">Нараховано rewards</div>
          <div class="v mono" id="kpiRewards">0</div>
          <div class="s mono" id="kpiPaidDays">0</div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" id="tab30">30 днів</button>
        <button class="tab" id="tab6m">6 місяців</button>
      </div>

      <div style="height:10px"></div>

      <div style="max-height: 520px; overflow:auto; border-radius:14px; border:1px solid #263246;">
        <table>
          <thead>
            <tr>
              <th>Day</th>
              <th>Date</th>
              <th>Weekday</th>
              <th>Rate %</th>
              <th>Reward</th>
              <th>Deposit</th>
              <th>Wallet end</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:12px;">
        Нарахування йде від суми потоку після підтяжки (boost). Deposit не змінюється від rewards, rewards лежать у wallet до моменту виводу.
      </div>
    </div>
  </div>

<script>
  function fmt(n) {
    if (!isFinite(n)) return "0";
    return new Intl.NumberFormat("en-US", { maximumFractionDigits: 8 }).format(n);
  }
  function fmtMoney(n, ccy) { return `${fmt(n)} ${ccy}`; }
  function weekdayName(d) { return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()]; }
  function addDays(date, days) { const d = new Date(date); d.setDate(d.getDate()+days); return d; }
  function addMonths(date, months) {
    const d = new Date(date);
    const day = d.getDate();
    d.setMonth(d.getMonth()+months);
    if (d.getDate() < day) d.setDate(0);
    return d;
  }
  function parseDateInput(value) {
    const parts = String(value || "").split("-");
    if (parts.length !== 3) return new Date();
    const y = Number(parts[0]), m = Number(parts[1]), dd = Number(parts[2]);
    return new Date(y, m-1, dd);
  }

  function parseWithdrawSet(s) {
    const set = new Set();
    const raw = (s || "").trim();
    if (!raw) return set;
    raw.split(",").map(x => x.trim()).filter(Boolean).forEach(d => set.add(d));
    return set;
  }

  function boostPctFromDeposit(amount) {
    const tiers = [
      { min: 100, pct: 130 },
      { min: 500, pct: 140 },
      { min: 1000, pct: 150 },
      { min: 2500, pct: 160 },
      { min: 5000, pct: 180 },
      { min: 10000, pct: 200 },
      { min: 25000, pct: 210 },
      { min: 50000, pct: 230 },
      { min: 100000, pct: 250 },
      { min: 250000, pct: 260 },
      { min: 500000, pct: 270 },
      { min: 1000000, pct: 280 },
    ];
    let pct = 100;
    for (const t of tiers) {
      if (amount >= t.min) pct = t.pct;
    }
    return pct;
  }

  // Core rules:
  // - depositAmount is the opened flow amount (after boost)
  // - rewards accrue into wallet only (no reinvest)
  // - Sunday: no reward, no +0.01 progress
  // - withdraw day: withdraw wallet (wallet -> 0), reset rate progress (next paid day starts at 0.3%)
  function buildSchedule({
    depositAmount,
    depositDate,
    startRatePct,
    rateStepPct,
    startNextDay,
    withdrawSet,
    horizonDays,
    horizonEndDate
  }) {
    const rows = [];

    const startDate = startNextDay ? addDays(depositDate, 1) : new Date(depositDate);

    let endDateExclusive;
    if (typeof horizonDays === "number") {
      endDateExclusive = addDays(startDate, horizonDays);
    } else if (horizonEndDate instanceof Date) {
      endDateExclusive = addDays(horizonEndDate, 1);
    } else {
      throw new Error("No horizon specified");
    }

    let rateIndex = 1;
    let wallet = 0;
    let totalAccrued = 0;
    let totalWithdrawn = 0;
    let paidDays = 0;

    for (let d = new Date(startDate); d < endDateExclusive; d = addDays(d, 1)) {
      const dateStr = d.toISOString().slice(0,10);
      const isSunday = (d.getDay() === 0);
      const isWithdraw = withdrawSet.has(dateStr);
      const weekday = weekdayName(d);

      let note = "";
      let ratePct = 0;
      let reward = 0;
      let withdrawnToday = 0;

      if (isWithdraw) {
        withdrawnToday = wallet;
        totalWithdrawn += withdrawnToday;
        wallet = 0;

        ratePct = 0;
        reward = 0;
        note = withdrawnToday > 0 ? `Withdraw rewards: ${fmt(withdrawnToday)}` : "Withdraw: wallet was 0";
        rateIndex = 1;
      } else if (isSunday) {
        ratePct = 0;
        reward = 0;
        note = "Sunday: no reward";
      } else {
        ratePct = startRatePct + (rateIndex - 1) * rateStepPct;
        reward = depositAmount * (ratePct / 100);

        wallet += reward;
        totalAccrued += reward;
        paidDays += 1;

        note = "Paid day: reward to wallet";
        rateIndex += 1;
      }

      rows.push({
        date: new Date(d),
        weekday,
        ratePct,
        reward,
        deposit: depositAmount,
        walletEnd: wallet,
        withdrawnToday,
        note
      });
    }

    return {
      rows,
      startDate,
      depositAmount,
      walletEnd: wallet,
      totalAccrued,
      totalWithdrawn,
      paidDays
    };
  }

  function render({ rows, currency, depositAmount, walletEnd, totalAccrued, totalWithdrawn, paidDays }) {
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    rows.forEach((r, idx) => {
      const dateStr = r.date.toISOString().slice(0,10);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${idx + 1}</td>
        <td class="mono">${dateStr}</td>
        <td class="mono">${r.weekday}</td>
        <td class="mono">${r.ratePct ? (fmt(r.ratePct) + "%") : ""}</td>
        <td class="mono">${fmtMoney(r.reward, currency)}</td>
        <td class="mono">${fmtMoney(r.deposit, currency)}</td>
        <td class="mono">${fmtMoney(r.walletEnd, currency)}</td>
        <td>${r.note}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("kpiWrap").style.display = "grid";
    document.getElementById("kpiStart").textContent = fmtMoney(depositAmount, currency);
    document.getElementById("kpiRows").textContent = `Days shown: ${rows.length}`;

    const totalValue = depositAmount + walletEnd;
    document.getElementById("kpiEnd").textContent = fmtMoney(totalValue, currency);
    document.getElementById("kpiGain").textContent = `Wallet now: ${fmtMoney(walletEnd, currency)} | Withdrawn: ${fmtMoney(totalWithdrawn, currency)}`;

    document.getElementById("kpiRewards").textContent = fmtMoney(totalAccrued, currency);
    const sundays = rows.filter(x => x.weekday === "Sun").length;
    const withdraws = rows.filter(x => (x.note || "").startsWith("Withdraw")).length;
    document.getElementById("kpiPaidDays").textContent = `Paid days: ${paidDays} | Sundays: ${sundays} | Withdraw days: ${withdraws}`;
  }

  let activeTab = "30";
  function setTab(tab) {
    activeTab = tab;
    document.getElementById("tab30").classList.toggle("active", tab === "30");
    document.getElementById("tab6m").classList.toggle("active", tab === "6m");
    calculate();
  }

  function calculate() {
    const baseDeposit = Number(document.getElementById("amount").value || 0);
    const currency = (document.getElementById("currency").value || "USDT").trim();
    const dateVal = document.getElementById("depositDate").value;
    if (!dateVal) { alert("Вкажи дату депозиту"); return; }

    const depositDate = parseDateInput(dateVal);
    const startRatePct = Number(document.getElementById("startRate").value || 0.3);
    const rateStepPct = Number(document.getElementById("rateStep").value || 0.01);
    const startNextDay = document.getElementById("startNextDay").checked;
    const withdrawSet = parseWithdrawSet(document.getElementById("withdrawDates").value);

    // ECR boost math
    const boostPct = boostPctFromDeposit(baseDeposit);
    const openedFlowAmount = baseDeposit * (boostPct / 100);
    const extraFiat = openedFlowAmount - baseDeposit;

    const ecrRate = Number(document.getElementById("ecrRate").value || 0);
    const ecrNeeded = (ecrRate > 0) ? (extraFiat / ecrRate) : 0;

    document.getElementById("boostPct").value = `${boostPct}%`;
    document.getElementById("boostedAmount").value = `${fmt(openedFlowAmount)} ${currency}`;
    document.getElementById("extraFiat").value = `${fmt(extraFiat)} ₮`;
    document.getElementById("ecrNeeded").value = `${fmt(ecrNeeded)} ECR`;

    let result;
    if (activeTab === "30") {
      result = buildSchedule({
        depositAmount: openedFlowAmount,
        depositDate,
        startRatePct,
        rateStepPct,
        startNextDay,
        withdrawSet,
        horizonDays: 30
      });
    } else {
      const startDate = startNextDay ? addDays(depositDate, 1) : new Date(depositDate);
      const endDate = addMonths(startDate, 6);
      result = buildSchedule({
        depositAmount: openedFlowAmount,
        depositDate,
        startRatePct,
        rateStepPct,
        startNextDay,
        withdrawSet,
        horizonEndDate: endDate
      });
    }

    render({ ...result, currency });

    window.__lastRows = result.rows.map((r, i) => ({
      Day: i+1,
      Date: r.date.toISOString().slice(0,10),
      Weekday: r.weekday,
      RatePct: r.ratePct,
      Reward: r.reward,
      Deposit: r.deposit,
      WalletEnd: r.walletEnd,
      WithdrawnToday: r.withdrawnToday,
      Note: r.note
    }));
  }

  function exportCSV() {
    const rows = window.__lastRows || [];
    if (!rows.length) { alert("Немає даних для експорту"); return; }

    const headers = Object.keys(rows[0]);
    const lines = [
      headers.join(","),
      ...rows.map(r => headers.map(h => {
        const val = r[h];
        const s = (val === null || val === undefined) ? "" : String(val);
        const escaped = s.replaceAll('"','""');
        return (escaped.includes(",") || escaped.includes('"') || escaped.includes("\n")) ? `"${escaped}"` : escaped;
      }).join(","))
    ];

    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "growing-flow.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  (function init(){
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,"0");
    const dd = String(now.getDate()).padStart(2,"0");
    document.getElementById("depositDate").value = `${yyyy}-${mm}-${dd}`;
    calculate();
  })();

  document.getElementById("calcBtn").addEventListener("click", calculate);
  document.getElementById("exportBtn").addEventListener("click", exportCSV);
  document.getElementById("tab30").addEventListener("click", () => setTab("30"));
  document.getElementById("tab6m").addEventListener("click", () => setTab("6m"));

  ["amount","depositDate","currency","startRate","rateStep","startNextDay","withdrawDates","ecrRate"]
    .forEach(id => document.getElementById(id).addEventListener("input", calculate));
</script>
</body>
</html>
