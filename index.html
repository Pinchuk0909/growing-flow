<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Growing Flow Calculator</title>

<style>
  :root{
    --red:#c00000;
    --black:#000;
    --white:#fff;
    --green:#00a000;

    /* currency colors */
    --usdtA:#10b981;
    --usdtB:#059669;
    --euroA:#3b82f6;
    --euroB:#2563eb;
  }
  *{ box-sizing:border-box; }

  body{
    margin:0;
    font-family: Arial, sans-serif;
    color:var(--black);
    background:
      linear-gradient(rgba(255,255,255,0.94), rgba(255,255,255,0.94)),
      url("logo.png") no-repeat center center fixed;
    background-size: 55%;
  }

  .wrap{ max-width:1200px; margin:0 auto; padding:20px; }

  .card{
    background:var(--white);
    border:3px solid var(--black);
    border-radius:18px;
    padding:18px;
    overflow:hidden;
  }

  .topbar{
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    grid-template-rows: auto auto;
    gap:8px 16px;
    align-items:start;
  }

  h1{
    margin:0;
    font-size:34px;
    line-height:1.05;
    color:var(--green);
    font-weight:800;
    grid-column:1;
    grid-row:1;
    align-self:start;
  }

  .topbar img{
    height:34px;
    width:auto;
    display:block;
    margin-top:4px;
    grid-column:3;
    grid-row:1;
    justify-self:end;
    align-self:start;
  }

  .regBtnWrap{
    grid-column:2;
    grid-row:1;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding-top:2px;
  }

  .regBtn{
    display:inline-block;
    width:auto;
    padding:10px 16px;
    border-radius:999px;
    border:2px solid var(--black);
    background:var(--red);
    color:var(--white);
    font-weight:900;
    text-decoration:none;
    cursor:pointer;
    line-height:1;
    box-shadow: 0 0 0 rgba(192,0,0,0);
    animation: regGlow 1.6s ease-in-out infinite;
  }
  .regBtn:hover{
    filter:brightness(0.95);
    animation: none;
    box-shadow: 0 0 22px rgba(192,0,0,0.55);
  }

  @keyframes regGlow{
    0%   { box-shadow: 0 0 0 rgba(192,0,0,0); transform: translateY(0); }
    50%  { box-shadow: 0 0 22px rgba(192,0,0,0.55); transform: translateY(1px); }
    100% { box-shadow: 0 0 0 rgba(192,0,0,0); transform: translateY(0); }
  }

  .regTextRow{
    grid-column:3;
    grid-row:2;
    justify-self:end;
    text-align:right;
    font-weight:800;
    line-height:1.25;
    padding-top:0;
    margin-top:-2px;
    max-width:520px;
  }

  .regSmall{
    font-size:12px;
    font-weight:800;
    line-height:1.25;
  }

  .regMeta{
    margin-top:6px;
    font-size:12px;
    font-weight:800;
    line-height:1.25;
  }

  .grid3{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:14px;
    margin-top:18px;
  }
  .grid2{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap:14px;
  }

  .box{
    border:2px solid var(--black);
    border-radius:14px;
    padding:12px;
    background:var(--white);
    overflow:hidden;
  }

  .boxTitle{
    color:var(--red);
    font-weight:800;
    margin:0 0 10px;
    font-size:18px;
  }

  label{
    display:block;
    font-size:13px;
    font-weight:700;
    margin:0 0 6px;
  }

  input, select, button{
    width:100%;
    padding:12px 12px;
    border:2px solid var(--black);
    border-radius:12px;
    background:var(--white);
    color:var(--black);
    font-size:14px;
    outline:none;
    min-width:0;
  }
  input:focus, select:focus{ border-color:var(--red); }
  input[readonly], select:disabled{ opacity:0.9; }

  .field{ position:relative; }
  .field.hasSuffix input,
  .field.hasSuffix select{ padding-right:78px; }

  .suffix{
    position:absolute;
    right:10px;
    top:50%;
    transform:translateY(-50%);
    font-weight:900;
    font-size:12px;
    color:var(--black);
    background:var(--white);
    padding:2px 10px;
    border-radius:999px;
    border:2px solid var(--black);
    pointer-events:none;
    line-height:1.3;
    white-space:nowrap;
  }

  #currency{ font-weight:900; }

  .currencyField{
    border-radius:14px;
    padding:10px;
    border:2px solid var(--black);
    background:var(--white);
  }
  .currencyField label{ margin-top:0; }

  .currencyField.usdt{
    border-color: var(--usdtB);
    box-shadow: 0 0 0 4px rgba(16,185,129,0.18);
    background:
      linear-gradient(0deg, rgba(16,185,129,0.09), rgba(16,185,129,0.09)),
      var(--white);
  }
  .currencyField.usdt label{ color: var(--usdtB); font-weight:900; }

  .currencyField.euro{
    border-color: var(--euroB);
    box-shadow: 0 0 0 4px rgba(59,130,246,0.18);
    background:
      linear-gradient(0deg, rgba(59,130,246,0.09), rgba(59,130,246,0.09)),
      var(--white);
  }
  .currencyField.euro label{ color: var(--euroB); font-weight:900; }

  .rowBtns{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:12px;
  }

  .btn{
    background:var(--red);
    color:var(--white);
    border-color:var(--black);
    font-weight:900;
    cursor:pointer;
    width:auto;
    padding:10px 14px;
    border-radius:12px;
  }
  .btn:hover{ filter:brightness(0.95); }

  .smallBtn{
    width:auto;
    padding:10px 12px;
    border-radius:12px;
    border:2px solid var(--black);
    background:var(--white);
    color:var(--black);
    font-weight:900;
    cursor:pointer;
  }
  .smallBtn.red{ background:var(--red); color:var(--white); }

  .badge{
    display:inline-flex;
    align-items:center;
    gap:10px;
    font-weight:900;
    font-size:12px;
    padding:8px 12px;
    border:2px solid var(--black);
    border-radius:999px;
    background:var(--white);
    user-select:none;
  }

  .tabs{
    display:flex;
    gap:10px;
    margin:14px 0 12px;
    flex-wrap:wrap;
  }
  .tab{
    width:auto;
    padding:10px 14px;
    border:2px solid var(--black);
    border-radius:999px;
    background:var(--white);
    color:var(--black);
    font-weight:900;
    cursor:pointer;
  }
  .tab.active{ background:var(--red); color:var(--white); }

  .summary{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:12px;
    margin-top:14px;
  }

  .kpi{
    border:2px solid var(--black);
    border-radius:14px;
    padding:12px;
    background:var(--white);
    overflow:hidden;
  }
  .kpi .t{ font-size:12px; font-weight:900; }
  .kpi .v{
    margin-top:6px;
    font-size:20px;
    font-weight:900;
    color:var(--red);
    font-family: monospace;
  }
  .kpi .s{
    margin-top:6px;
    font-size:12px;
    font-weight:800;
    font-family: monospace;
  }

  .tableWrap{
    margin-top:12px;
    border:2px solid var(--black);
    border-radius:14px;
    overflow:auto;
    max-height:520px;
    background:var(--white);
    -webkit-overflow-scrolling: touch;
  }

  table{
    width:100%;
    border-collapse:collapse;
    min-width:980px;
    background-image:
      linear-gradient(rgba(255,255,255,0.88), rgba(255,255,255,0.88)),
      url("table-bg.png");
    background-repeat:repeat;
    background-size:220px 220px;
    background-position:center center;
  }

  thead th{
    position:sticky;
    top:0;
    background:var(--black);
    color:var(--white);
    padding:10px;
    font-size:12px;
    text-align:left;
    white-space:nowrap;
    border-bottom:2px solid var(--black);
  }
  tbody td{
    padding:10px;
    border-bottom:2px solid var(--black);
    font-size:13px;
    white-space:nowrap;
    font-family: monospace;
    background:transparent;
  }
  tbody tr{ background:transparent; }

  .withdrawList{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap:10px;
    margin-top:10px;
  }

  .withdrawItem{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .withdrawItem input{ flex:1; }

  .xBtn{
    width:auto;
    padding:10px 12px;
    border-radius:12px;
    border:2px solid var(--black);
    background:var(--white);
    color:var(--black);
    font-weight:900;
    cursor:pointer;
    flex:0 0 auto;
  }
  .xBtn:hover{ background:var(--red); color:var(--white); }

  .error{
    margin-top:10px;
    padding:10px 12px;
    border:2px solid var(--red);
    border-radius:12px;
    color:var(--red);
    font-weight:900;
    display:none;
  }

  .ecrHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }

  @media (max-width: 900px){
    .grid3{ grid-template-columns: 1fr; }
    .grid2{ grid-template-columns: 1fr; }
    .summary{ grid-template-columns: 1fr; }
    .withdrawList{ grid-template-columns: 1fr; }
    h1{ font-size:28px; }
  }

  @media (max-width: 520px){
    body{ background-size: 85%; }
    .wrap{ padding:12px; }
    .card{ padding:14px; border-radius:16px; border-width:3px; }

    .topbar{
      grid-template-columns: 1fr;
      grid-template-rows: auto auto auto auto;
      gap:10px;
    }
    h1{ font-size:26px; grid-column:1; grid-row:1; }
    .regBtnWrap{ grid-column:1; grid-row:2; justify-content:flex-start; }
    .topbar img{ grid-column:1; grid-row:3; justify-self:start; height:30px; margin-top:0; }
    .regTextRow{ grid-column:1; grid-row:4; justify-self:start; text-align:left; max-width:none; margin-top:0; }
  }

  @media (max-width: 360px){
    h1{ font-size:24px; }
    .field.hasSuffix input,
    .field.hasSuffix select{ padding-right:60px; }
    .suffix{ padding:2px 7px; }
    table{ min-width:820px; }
  }

  .ratesHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }

  .infoBtn{
    width:auto;
    padding:6px 10px;
    border-radius:999px;
    border:2px solid var(--black);
    background:var(--white);
    color:var(--black);
    font-weight:900;
    cursor:pointer;
    line-height:1;
    flex:0 0 auto;
  }
  .infoBtn:hover{
    border-color:var(--red);
    color:var(--red);
  }

  .infoOverlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.35);
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    z-index:9999;
  }
  .infoOverlay.open{ display:flex; }

  .infoModal{
    width:min(640px, 100%);
    background:var(--white);
    border:3px solid var(--black);
    border-radius:16px;
    padding:14px 14px 12px;
  }

  .infoTop{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:8px;
  }
  .infoTitle{
    font-weight:900;
    color:var(--red);
    font-size:16px;
  }
  .infoClose{
    width:auto;
    padding:8px 12px;
    border-radius:12px;
    border:2px solid var(--black);
    background:var(--white);
    font-weight:900;
    cursor:pointer;
  }
  .infoClose:hover{ background:var(--red); color:var(--white); }

  .infoBody{
    font-size:13px;
    line-height:1.45;
    font-weight:700;
    color:var(--black);
  }
  .infoBody b{ font-weight:900; }
</style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <div class="topbar">
      <h1>Growing Flow Calculator</h1>

      <div class="regBtnWrap">
        <a class="regBtn" id="regBtn" href="#" target="_blank" rel="noopener">REGISTRATION</a>
      </div>

      <img src="cashflow.png" alt="CASHFLOW" />

      <div class="regTextRow">
        <div class="regSmall">They helped you, so help them too.</div>
        <div class="regMeta">
          Developed Pinchuk Alexander<br>
          EMAIL:&nbsp; ah.althouse@gmail.com
        </div>
      </div>
    </div>

    <div class="grid3">
      <div class="field hasSuffix">
        <label>Deposit</label>
        <input id="amount" type="text" inputmode="decimal" value="1000" />
        <span class="suffix" id="depositSuffix">USDT</span>
      </div>

      <div class="field">
        <label>Deposit date</label>
        <input id="depositDate" type="date" />
      </div>

      <div class="currencyField usdt" id="currencyField">
        <label>Currency</label>
        <select id="currency">
          <option value="USDT">USDT</option>
          <option value="EURO">EURO</option>
        </select>
      </div>
    </div>

    <div class="box" style="margin-top:14px;">
      <div class="ecrHeader">
        <div class="boxTitle" style="margin:0;">ECR boost</div>
        <div class="badge" title="Auto mode only">MODE&nbsp;AUTO</div>
      </div>

      <div class="grid3">
        <div class="field hasSuffix">
          <label>ECR rate</label>
          <input id="ecrRate" type="text" inputmode="decimal" value="816.80" />
          <span class="suffix" id="fiatSymbol">₮</span>
        </div>

        <div class="field">
          <label>Flow multiplier</label>
          <select id="multiplier"></select>
        </div>

        <div class="field hasSuffix">
          <label>Flow opens on</label>
          <input id="flowOpensOn" type="text" readonly />
          <span class="suffix" id="flowSuffix">USDT</span>
        </div>
      </div>

      <div class="grid3" style="margin-top:12px;">
        <div class="field hasSuffix">
          <label>Extra needed</label>
          <input id="extraNeeded" type="text" inputmode="decimal" />
          <span class="suffix" id="fiatSymbol2">₮</span>
        </div>

        <div class="field hasSuffix">
          <label>ECR required</label>
          <input id="ecrRequired" type="text" readonly />
          <span class="suffix">ECR</span>
        </div>

        <div class="field">
          <label>Status</label>
          <input id="status" type="text" readonly value="ECR = extra / rate" />
        </div>
      </div>

      <div class="rowBtns">
        <button class="smallBtn" id="resetAutoBtn" type="button">Reset auto</button>
      </div>

      <div class="error" id="errBox"></div>
    </div>

    <div class="grid2" style="margin-top:14px;">
      <div class="box">
        <div class="boxTitle">Withdraw dates</div>
        <div style="font-size:13px;font-weight:800;">
          Add up to 10 dates. On withdraw date: wallet resets and rate progress resets. No reward on that day.
        </div>

        <div class="rowBtns">
          <button class="smallBtn red" id="addWithdrawBtn" type="button">+ Add date</button>
          <button class="smallBtn" id="clearWithdrawBtn" type="button">Clear</button>
        </div>

        <div class="withdrawList" id="withdrawList"></div>
      </div>

      <div class="box">
        <div class="ratesHeader">
          <div class="boxTitle" style="margin:0;">Rates</div>
          <button class="infoBtn" id="infoBtn" type="button">Info</button>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div class="field hasSuffix">
            <label>Start rate</label>
            <input id="startRate" type="text" inputmode="decimal" value="0.30" />
            <span class="suffix">%</span>
          </div>
          <div class="field hasSuffix">
            <label>Daily bonus</label>
            <input id="rateStep" type="text" inputmode="decimal" value="0.01" />
            <span class="suffix">%</span>
          </div>
        </div>

        <div style="margin-top:12px;">
          <label style="display:flex;align-items:center;gap:10px;font-weight:900;">
            <input id="startNextDay" type="checkbox" checked style="width:auto;margin:0;" />
            Start accrual from next day after deposit
          </label>
        </div>
      </div>
    </div>

    <div class="infoOverlay" id="infoOverlay" aria-hidden="true">
      <div class="infoModal" role="dialog" aria-modal="true" aria-labelledby="infoTitle">
        <div class="infoTop">
          <div class="infoTitle" id="infoTitle">Growing Flow rules</div>
          <button class="infoClose" id="infoClose" type="button">X</button>
        </div>
        <div class="infoBody">
          <b>Accrual rules</b><br><br>
          Reward is calculated from the current flow balance.<br>
          After reward, flow balance decreases by reward amount.<br>
          Daily bonus +0.01% works only for first 3 months from accrual start.<br>
          Sunday: no reward and no bonus increase.<br><br>
          Rewards go to wallet (no reinvest).<br>
          Withdraw resets wallet and rate progress. No reward on that day.<br>
        </div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="7" type="button">7 days</button>
      <button class="tab" data-tab="15" type="button">15 days</button>
      <button class="tab" data-tab="30" type="button">30 days</button>
      <button class="tab" data-tab="2m" type="button">2 months</button>
      <button class="tab" data-tab="6m" type="button">6 months</button>
    </div>

    <div class="rowBtns">
      <button class="btn" id="calcBtn" type="button">Calculate</button>
      <button class="smallBtn" id="exportBtn" type="button">Export CSV</button>
    </div>

    <div class="summary" id="kpiWrap" style="display:none;">
      <div class="kpi">
        <div class="t">Opened flow amount</div>
        <div class="v" id="kpiFlow">0</div>
        <div class="s" id="kpiMeta">0</div>
      </div>
      <div class="kpi">
        <div class="t">Wallet end / Withdrawn total</div>
        <div class="v" id="kpiWallet">0</div>
        <div class="s" id="kpiWithdrawn">Withdrawn: 0</div>
      </div>
      <div class="kpi">
        <div class="t">Total accrued rewards</div>
        <div class="v" id="kpiAccrued">0</div>
        <div class="s" id="kpiDays">Paid days: 0</div>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Day</th>
            <th>Date</th>
            <th>Weekday</th>
            <th>Rate %</th>
            <th>Reward</th>
            <th>Flow amount</th>
            <th>Wallet end</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

  </div>
</div>

<script>
  const $ = (id)=>document.getElementById(id);

  const USDT_TIERS = [
    { min:100, pct:130 },
    { min:500, pct:140 },
    { min:1000, pct:150 },
    { min:2500, pct:160 },
    { min:5000, pct:180 },
    { min:10000, pct:200 },
    { min:25000, pct:210 },
    { min:50000, pct:230 },
    { min:100000, pct:250 },
    { min:250000, pct:260 },
    { min:500000, pct:270 },
    { min:1000000, pct:280 },
  ];

  const EURO_TIERS = [
    { min:50, bonus:50 },
    { min:100, bonus:60 },
    { min:250, bonus:70 },
    { min:500, bonus:80 },
    { min:1000, bonus:100 },
    { min:2000, bonus:110 },
    { min:3000, bonus:120 },
    { min:5000, bonus:130 },
    { min:10000, bonus:150 },
  ];

  function toNum(raw){
    const s = String(raw ?? "")
      .trim()
      .replaceAll(" ", "")
      .replaceAll(",", ".");
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function fmt(n, digits=8){
    if(!Number.isFinite(n)) return "";
    return new Intl.NumberFormat("en-US",{maximumFractionDigits:digits}).format(n);
  }

  function fmtMoney(n, ccy){
    if(!Number.isFinite(n)) return "0 " + ccy;
    return fmt(n, 8) + " " + ccy;
  }

  function weekdayName(d){ return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()]; }
  function addDays(date, days){ const d=new Date(date); d.setDate(d.getDate()+days); return d; }
  function addMonths(date, months){
    const d=new Date(date);
    const day=d.getDate();
    d.setMonth(d.getMonth()+months);
    if(d.getDate()<day) d.setDate(0);
    return d;
  }
  function parseDateInput(value){
    const parts = String(value||"").split("-").map(Number);
    const y = parts[0], m = parts[1], dd = parts[2];
    if(!y || !m || !dd) return null;
    return new Date(y, (m-1), dd);
  }

  function showErr(msg){
    const box = $("errBox");
    if(!msg){
      box.style.display="none";
      box.textContent="";
      return;
    }
    box.style.display="block";
    box.textContent=msg;
  }

  const withdrawListEl = $("withdrawList");
  const addWithdrawBtn = $("addWithdrawBtn");

  function syncWithdrawMeta(){
    const count = withdrawListEl.querySelectorAll('input[type="date"]').length;
    addWithdrawBtn.disabled = count >= 10;
  }

  function createWithdrawRow(value=""){
    const wrap = document.createElement("div");
    wrap.className = "withdrawItem";

    const input = document.createElement("input");
    input.type = "date";
    input.value = value;

    const del = document.createElement("button");
    del.type = "button";
    del.className = "xBtn";
    del.textContent = "X";
    del.addEventListener("click", () => {
      wrap.remove();
      syncWithdrawMeta();
    });

    wrap.appendChild(input);
    wrap.appendChild(del);
    return wrap;
  }

  function getWithdrawDates(){
    const inputs = Array.from(withdrawListEl.querySelectorAll('input[type="date"]'));
    const dates = inputs.map(i => i.value).filter(Boolean);
    return Array.from(new Set(dates)).sort();
  }
  function getWithdrawSet(){ return new Set(getWithdrawDates()); }

  $("addWithdrawBtn").addEventListener("click", () => {
    const count = withdrawListEl.querySelectorAll('input[type="date"]').length;
    if(count >= 10) return;
    withdrawListEl.appendChild(createWithdrawRow(""));
    syncWithdrawMeta();
  });

  $("clearWithdrawBtn").addEventListener("click", () => {
    withdrawListEl.innerHTML = "";
    withdrawListEl.appendChild(createWithdrawRow(""));
    syncWithdrawMeta();
  });

  function fillMultiplierOptions(){
    const ccy = $("currency").value;
    const sel = $("multiplier");
    sel.innerHTML = "";

    if(ccy === "USDT"){
      for(const t of USDT_TIERS){
        const opt = document.createElement("option");
        opt.value = String(t.pct);
        opt.textContent = `from ${t.min.toLocaleString("en-US")} → ${t.pct}%`;
        sel.appendChild(opt);
      }
    } else {
      for(const t of EURO_TIERS){
        const mult = 100 + t.bonus;
        const opt = document.createElement("option");
        opt.value = String(mult);
        opt.textContent = `from ${t.min.toLocaleString("en-US")} → +${t.bonus}% (${mult}%)`;
        sel.appendChild(opt);
      }
    }
  }

  function autoPickMultiplierByDeposit(){
    const dep = toNum($("amount").value);
    const ccy = $("currency").value;
    const sel = $("multiplier");
    if(!Number.isFinite(dep) || dep <= 0) return;

    if(ccy === "USDT"){
      let pct = 100;
      for(const t of USDT_TIERS) if(dep >= t.min) pct = t.pct;
      const opts = Array.from(sel.options);
      let best = opts[0];
      for(const o of opts){
        const v = Number(o.value);
        if(v <= pct) best = o;
      }
      sel.value = best.value;
    } else {
      let mult = 100;
      for(const t of EURO_TIERS) if(dep >= t.min) mult = 100 + t.bonus;
      const opts = Array.from(sel.options);
      let best = opts[0];
      for(const o of opts){
        const v = Number(o.value);
        if(v <= mult) best = o;
      }
      sel.value = best.value;
    }
  }

  function syncCurrencyUI(){
    const ccy = $("currency").value;
    $("depositSuffix").textContent = ccy;
    $("flowSuffix").textContent = ccy;

    const sym = (ccy === "EURO") ? "€" : "₮";
    $("fiatSymbol").textContent = sym;
    $("fiatSymbol2").textContent = sym;

    const cf = $("currencyField");
    cf.classList.remove("usdt","euro");
    cf.classList.add(ccy === "EURO" ? "euro" : "usdt");
  }

  function syncRegLink(){
    const ccy = $("currency").value;
    const btn = $("regBtn");
    if(!btn) return;

    btn.href = (ccy === "EURO")
      ? "https://eur.cashflow.fund/ref/N6ouTKSq"
      : "https://vip.cashflow.fund/ref/dTguTKSq";
  }

  function computeEcrBlock(){
    showErr("");

    const dep = toNum($("amount").value);
    const ecrRate = toNum($("ecrRate").value);
    const multPct = toNum($("multiplier").value);

    if(!Number.isFinite(dep) || dep <= 0){
      showErr("Deposit must be a positive number");
      return null;
    }
    if(!Number.isFinite(ecrRate) || ecrRate <= 0){
      showErr("ECR rate must be a positive number");
      return null;
    }
    if(!Number.isFinite(multPct) || multPct <= 0){
      showErr("Flow multiplier is required");
      return null;
    }

    const flow = dep * (multPct/100);
    const extra = Math.max(0, flow - dep);
    const ecr = extra / ecrRate;

    $("flowOpensOn").value = fmt(flow, 8);
    $("extraNeeded").value = fmt(extra, 8);
    $("ecrRequired").value = fmt(ecr, 8);

    return { ccy: $("currency").value, dep, flow, extra, ecrRate, ecr };
  }

  function buildSchedule({
    flowAmount,
    depositDate,
    startRatePct,
    rateStepPct,
    startNextDay,
    withdrawSet,
    endExclusive,
    bonusStopAfterMonths = 3
  }){
    const rows=[];
    const startDate = startNextDay ? addDays(depositDate,1) : new Date(depositDate);
    const bonusStopDate = addMonths(startDate, bonusStopAfterMonths);

    let currentFlow = Number(flowAmount);
    if(!Number.isFinite(currentFlow) || currentFlow <= 0){
      return { rows: [], walletEnd: 0, totalAccrued: 0, totalWithdrawn: 0, paidDays: 0 };
    }

    let rateIndex = 1;
    let wallet = 0;
    let totalAccrued = 0;
    let totalWithdrawn = 0;
    let paidDays = 0;

    for(let d=new Date(startDate); d<endExclusive; d=addDays(d,1)){
      const dateStr = d.toISOString().slice(0,10);
      const isSunday = d.getDay()===0;
      const isWithdraw = withdrawSet.has(dateStr);

      let ratePct = 0, reward = 0, note = "";

      if(isWithdraw){
        totalWithdrawn += wallet;
        wallet = 0;

        // після withdraw ставка скидається
        rateIndex = 1;

        note = "Withdraw: reset (no reward today)";

        // потік не змінюємо
      }
      else if(isSunday){
        note = "Sunday: no reward";
      }
      else{
        const flowBefore = currentFlow;

        // якщо ми вже після 3 місяців, бонус не росте взагалі
        // тому ставка або продовжує зафіксованою (якщо вже встигла вирости),
        // або після withdraw залишається 0.3
        const canGrowBonusToday = (d < bonusStopDate);

        ratePct = startRatePct + (rateIndex - 1) * rateStepPct;
        reward = flowBefore * (ratePct / 100);

        wallet += reward;
        totalAccrued += reward;
        paidDays += 1;

        // списуємо reward з потоку
        currentFlow = flowBefore - reward;

        note = canGrowBonusToday ? "Paid day" : "Paid day (bonus stopped)";

        if(canGrowBonusToday){
          rateIndex += 1;
        }
      }

      rows.push({
        date: new Date(d),
        weekday: weekdayName(d),
        ratePct,
        reward,
        flowAmount: currentFlow,
        walletEnd: wallet,
        note
      });
    }

    return { rows, walletEnd: wallet, totalAccrued, totalWithdrawn, paidDays };
  }

  function renderTable(rows, currency){
    const tbody = $("tbody");
    tbody.innerHTML = "";
    rows.forEach((r, idx) => {
      const tr = document.createElement("tr");
      const dateStr = r.date.toISOString().slice(0,10);
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${dateStr}</td>
        <td>${r.weekday}</td>
        <td>${r.ratePct ? (fmt(r.ratePct, 8) + "%") : ""}</td>
        <td>${fmtMoney(r.reward, currency)}</td>
        <td>${fmtMoney(r.flowAmount, currency)}</td>
        <td>${fmtMoney(r.walletEnd, currency)}</td>
        <td>${r.note}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function calculate(){
    const core = computeEcrBlock();
    if(!core) return;

    const dateVal = $("depositDate").value;
    const depositDate = parseDateInput(dateVal);
    if(!depositDate){
      showErr("Deposit date is required");
      return;
    }

    const startRatePct = toNum($("startRate").value);
    const rateStepPct = toNum($("rateStep").value);
    if(!Number.isFinite(startRatePct) || startRatePct <= 0){
      showErr("Start rate must be a positive number");
      return;
    }
    if(!Number.isFinite(rateStepPct) || rateStepPct < 0){
      showErr("Daily bonus must be 0 or positive");
      return;
    }

    const startNextDay = $("startNextDay").checked;
    const withdrawSet = getWithdrawSet();

    const activeTab = document.querySelector(".tab.active")?.dataset?.tab || "7";
    const startDate = startNextDay ? addDays(depositDate,1) : new Date(depositDate);

    let endExclusive;
    if(activeTab === "7") endExclusive = addDays(startDate, 7);
    if(activeTab === "15") endExclusive = addDays(startDate, 15);
    if(activeTab === "30") endExclusive = addDays(startDate, 30);
    if(activeTab === "2m") endExclusive = addMonths(startDate, 2);
    if(activeTab === "6m") endExclusive = addMonths(startDate, 6);

    const result = buildSchedule({
      flowAmount: core.flow,
      depositDate,
      startRatePct,
      rateStepPct,
      startNextDay,
      withdrawSet,
      endExclusive,
      bonusStopAfterMonths: 3
    });

    renderTable(result.rows, core.ccy);

    $("kpiWrap").style.display = "grid";
    $("kpiFlow").textContent = fmtMoney(core.flow, core.ccy);
    $("kpiMeta").textContent = `Currency: ${core.ccy} | Withdraw dates: ${getWithdrawDates().length}/10 | Period: ${activeTab}`;
    $("kpiWallet").textContent = fmtMoney(result.walletEnd, core.ccy);
    $("kpiWithdrawn").textContent = "Withdrawn: " + fmtMoney(result.totalWithdrawn, core.ccy);
    $("kpiAccrued").textContent = fmtMoney(result.totalAccrued, core.ccy);
    $("kpiDays").textContent = "Paid days: " + result.paidDays;

    window.__lastRows = result.rows.map((r,i)=>({
      Day: i+1,
      Date: r.date.toISOString().slice(0,10),
      Weekday: r.weekday,
      RatePct: r.ratePct,
      Reward: r.reward,
      FlowAmount: r.flowAmount,
      WalletEnd: r.walletEnd,
      Note: r.note
    }));

    syncWithdrawMeta();
  }

  function exportCSV(){
    const rows = window.__lastRows || [];
    if(!rows.length){ alert("No data"); return; }

    const headers = Object.keys(rows[0]);
    const lines = [
      headers.join(","),
      ...rows.map(r => headers.map(h => {
        const s = String(r[h] ?? "");
        const esc = s.replaceAll('"','""');
        return (esc.includes(",") || esc.includes('"') || esc.includes("\n")) ? `"${esc}"` : esc;
      }).join(","))
    ];

    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "growing-flow.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  $("currency").addEventListener("change", ()=>{
    syncCurrencyUI();
    syncRegLink();
    fillMultiplierOptions();
    autoPickMultiplierByDeposit();
    computeEcrBlock();
    calculate();
  });

  $("amount").addEventListener("input", ()=>{
    autoPickMultiplierByDeposit();
    computeEcrBlock();
  });

  $("multiplier").addEventListener("change", ()=>{
    computeEcrBlock();
    calculate();
  });

  $("ecrRate").addEventListener("input", ()=>{
    computeEcrBlock();
    calculate();
  });

  $("depositDate").addEventListener("change", calculate);
  $("startRate").addEventListener("input", calculate);
  $("rateStep").addEventListener("input", calculate);
  $("startNextDay").addEventListener("change", calculate);

  $("resetAutoBtn").addEventListener("click", ()=>{
    fillMultiplierOptions();
    autoPickMultiplierByDeposit();
    computeEcrBlock();
    calculate();
  });

  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      calculate();
    });
  });

  $("calcBtn").addEventListener("click", calculate);
  $("exportBtn").addEventListener("click", exportCSV);

  (function initInfo(){
    const btn = $("infoBtn");
    const overlay = $("infoOverlay");
    const close = $("infoClose");

    function openInfo(){
      overlay.classList.add("open");
      overlay.setAttribute("aria-hidden","false");
    }
    function closeInfo(){
      overlay.classList.remove("open");
      overlay.setAttribute("aria-hidden","true");
    }

    btn.addEventListener("click", openInfo);
    close.addEventListener("click", closeInfo);

    overlay.addEventListener("click", (e)=>{
      if(e.target === overlay) closeInfo();
    });

    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && overlay.classList.contains("open")) closeInfo();
    });
  })();

  (function init(){
    const now = new Date();
    $("depositDate").value = now.toISOString().slice(0,10);

    withdrawListEl.innerHTML = "";
    withdrawListEl.appendChild(createWithdrawRow(""));
    syncWithdrawMeta();

    syncCurrencyUI();
    syncRegLink();
    fillMultiplierOptions();
    autoPickMultiplierByDeposit();
    computeEcrBlock();
    calculate();
  })();
</script>
</body>
</html>
